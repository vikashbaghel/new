name: Create File and Notify Slack with PR Comment

on:
  pull_request:
    branches:
      - master
    types:
      - closed

jobs:
  fetch_comment_and_notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Fetch PR Details
        run: |
          PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body')
          ESCAPED_BODY=$(printf "%s" "$PR_BODY" | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g' -e 's/"/\\"/g')
          printf "PR_BODY=%s\n" "$ESCAPED_BODY" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Post APK URL to Slack
        run: |
          ESCAPED_BODY=$(echo "${PR_BODY}" | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g' -e 's/"/\\"/g')
          curl -X POST -H 'Content-Type: application/json' -d "{
            \"text\": \"${ESCAPED_BODY}\\nDownload the AAB file version : <|Click Here>\"
          }" $SLACK_WEBHOOK_URL
        env:
          PR_BODY: ${{ env.PR_BODY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Post Failure Notification to Slack for AAB
        if: ${{ failure() }}
        run: |
          curl -X POST -H 'Content-Type: application/json' -d '{
            "text": "Build failed for AAB! Please check the workflow for details."
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Write Comment to File
        run: |
          echo "${PR_BODY}" > pr_comment.txt
          cat pr_comment.txt  # Output the comment to the console
